#!/usr/bin/env bash
#
# E-Paper Library Build Script
#
# Configures and builds the libepaper2 library, examples, and tests.
#
# Usage:
#   ./bin/build                              # Build everything (Release by default)
#   ./bin/build [target]                     # Build specific target (Release)
#   ./bin/build [target] --type Debug        # Build specific target with Debug config
#   BUILD_TYPE=Debug ./bin/build examples    # Alternative via env var
#
# Available targets:
#   all                - Build library, examples, and tests (default)
#   libepaper         - Build library only
#   examples          - Build all examples
#   crypto_dashboard  - Build crypto dashboard example
#   tests             - Build all tests
#   test_auto_sleep   - Build specific test
#
# Examples:
#   ./bin/build                              # Build everything
#   ./bin/build crypto_dashboard             # Build one example
#   cmake --build build --target tests       # Build tests only
#
# Output:
#   build/lib/libepaper.a                    # Static library
#   build/examples/crypto_dashboard/...      # Example binaries
#   build/tests/...                          # Test binaries
#
# Requirements:
#   - CMake 3.25+
#   - GCC 14+ or Clang 18+
#   - Dependencies installed (run ./bin/setup first)
#
# Documentation: README.md#quick-start

set -e

echo "==================================="
echo "E-Paper Library Build"
echo "==================================="
echo ""

echo "Remember to run this command from the root directory of the project."
echo ""

# Defaults
TARGET="all"
BUILD_TYPE="${BUILD_TYPE:-Release}"
DRIVER="${LIBEPAPER_DRIVER:-EPD27}"

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --type)
      BUILD_TYPE="$2"; shift 2 ;;
    -t)
      BUILD_TYPE="$2"; shift 2 ;;
    --type=*)
      BUILD_TYPE="${1#*=}"; shift ;;
    --driver)
      DRIVER="$2"; shift 2 ;;
    --driver=*)
      DRIVER="${1#*=}"; shift ;;
    all|libepaper|epaper|examples|crypto_dashboard|tests|test_auto_sleep)
      TARGET="$1"; shift ;;
    *)
      echo "Unknown argument: $1" >&2; exit 1 ;;
  esac
done

echo "Configuring build (type: ${BUILD_TYPE}, driver: ${DRIVER})..."
cmake -S . -B build \
  -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
  -DCMAKE_CXX_COMPILER=g++-14 \
  -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
  -DLIBEPAPER_DRIVER="${DRIVER}"

echo ""
echo "Building target: ${TARGET}..."
if [ "${TARGET}" = "all" ]; then
  cmake --build build -j$(nproc)
else
  cmake --build build --target "${TARGET}" -j$(nproc)
fi

echo ""
echo "==================================="
echo "Build complete!"
echo "==================================="
echo ""
echo "Run examples (no sudo required):"
echo "  ./build/examples/crypto_dashboard/crypto_dashboard"
echo ""
echo "Run tests (no sudo required):"
echo "  ./build/tests/test_auto_sleep"
echo ""
echo "Note: Make sure you're in the gpio and spi groups"
echo ""
