#!/bin/bash
#
# E-Paper Library Setup Script
# 
# Installs all dependencies and configures the development environment
# for libepaper2 on Raspberry Pi.
#
# Usage:
#   ./bin/setup
#
# What it does:
#   - Checks if running on Raspberry Pi
#   - Updates package lists
#   - Installs build tools (CMake, GCC 14, Clang)
#   - Installs libraries (libgpiod, cURL, nlohmann-json)
#   - Adds user to gpio group (for GPIO access without sudo)
#   - Enables SPI interface
#   - Configures Git settings (optional)
#
# Requirements:
#   - Raspberry Pi OS
#   - Internet connection
#   - sudo privileges
#
# Documentation: README.md#quick-start

set -e

echo "==================================="
echo "E-Paper Library Setup"
echo "==================================="
echo ""

# Check if running on Raspberry Pi
if [ ! -f /proc/device-tree/model ] || ! grep -q "Raspberry Pi" /proc/device-tree/model 2>/dev/null; then
    echo "Warning: This doesn't appear to be a Raspberry Pi"
    echo "Press Ctrl+C to cancel, or Enter to continue anyway..."
    read
fi

# Update package list
echo "Updating package list..."
sudo apt update

# Install dependencies
echo ""
echo "Installing dependencies..."
sudo apt install -y \
    cmake \
    g++-14 \
    clang \
    clangd \
    libgpiod-dev \
    libcurl4-openssl-dev \
    nlohmann-json3-dev \
    ninja-build \
    pkg-config

# Check compiler versions
echo ""
echo "Checking compiler versions..."
g++-14 --version | head -n 1
echo ""

# Clean and build
echo ""
echo "Removing old build directory..."
if [ -d "build" ]; then
    rm -rf build
fi

echo "Configuring build..."
cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_CXX_COMPILER=g++-14

echo ""
echo "Checking if SPI is enabled..."
if [ -e /dev/spidev0.0 ]; then
    echo "SPI is enabled"
else
    echo "SPI is not enabled... enabling now"
    sudo raspi-config nonint do_spi 0
    echo "SPI enabled. You may need to reboot for changes to take effect."
fi

# Check and add user to gpio and spi groups
echo ""
echo "Checking GPIO and SPI group membership..."
CURRENT_USER="${SUDO_USER:-$USER}"
if [ -z "$CURRENT_USER" ]; then
    CURRENT_USER=$(whoami)
fi

GPIO_ADDED=false
SPI_ADDED=false

if groups "$CURRENT_USER" | grep -q "\bgpio\b"; then
    echo "User '$CURRENT_USER' is already in the gpio group"
else
    echo "Adding user '$CURRENT_USER' to gpio group..."
    sudo usermod -a -G gpio "$CURRENT_USER"
    GPIO_ADDED=true
    echo "User '$CURRENT_USER' has been added to the gpio group"
fi

if groups "$CURRENT_USER" | grep -q "\bspi\b"; then
    echo "User '$CURRENT_USER' is already in the spi group"
else
    echo "Adding user '$CURRENT_USER' to spi group..."
    sudo usermod -a -G spi "$CURRENT_USER"
    SPI_ADDED=true
    echo "User '$CURRENT_USER' has been added to the spi group"
fi

if [ "$GPIO_ADDED" = true ] || [ "$SPI_ADDED" = true ]; then
    echo ""
    echo "⚠️  IMPORTANT: Group membership changes require a new login session."
    echo "   Please log out and log back in (or reboot) for GPIO/SPI access to work."
    echo "   After logging back in, you can verify with: groups"
fi

# Verify gpiochip0 exists
echo ""
echo "Checking GPIO chip availability..."
if [ -e /dev/gpiochip0 ]; then
    echo "GPIO chip /dev/gpiochip0 is available"
else
    echo "Warning: /dev/gpiochip0 not found. GPIO operations may not work."
fi

echo ""
echo "==================================="
echo "Setup Complete!"
echo "==================================="
echo ""
echo "Next steps:"
echo "  1. If you were added to the gpio group, log out and log back in"
echo "  2. Verify GPIO access: groups (should show 'gpio')"
echo "  3. Build the library: ./bin/build"
echo "  4. Run examples: cd build && ./examples/crypto_dashboard/crypto_dashboard"
echo ""

