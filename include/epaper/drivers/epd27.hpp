#pragma once

#include "epaper/device.hpp"
#include "epaper/drivers/driver.hpp"
#include <array>
#include <cstddef>
#include <cstdint>
#include <expected>

namespace epaper {

// 2.7 inch e-paper display driver (176x264 pixels)
class EPD27 : public Driver {
public:
  static constexpr std::size_t WIDTH = 176;
  static constexpr std::size_t HEIGHT = 264;

  explicit EPD27(Device &device);
  ~EPD27() override = default;

  // Driver interface implementation
  [[nodiscard]] auto init(DisplayMode mode) -> std::expected<void, DriverError> override;
  auto clear() -> void override;
  auto display(std::span<const std::byte> buffer) -> void override;
  auto sleep() -> void override;

  [[nodiscard]] auto width() const noexcept -> std::size_t override { return WIDTH; }
  [[nodiscard]] auto height() const noexcept -> std::size_t override { return HEIGHT; }
  [[nodiscard]] auto mode() const noexcept -> DisplayMode override { return current_mode_; }
  [[nodiscard]] auto buffer_size() const noexcept -> std::size_t override;

private:
  // Hardware reset
  auto reset() -> void;

  // Low-level command/data transmission
  auto send_command(std::uint8_t command) -> void;
  auto send_data(std::uint8_t data) -> void;

  // Wait for display to be ready
  auto wait_busy() -> void;

  // LUT (Look-Up Table) initialization
  auto set_lut_bw() -> void;
  auto set_lut_grayscale() -> void;

  Device &device_;
  DisplayMode current_mode_ = DisplayMode::BlackWhite;
  bool initialized_ = false;

  // LUT tables for black/white mode
  static constexpr std::array<std::uint8_t, 44> LUT_VCOM_DC = {
      0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x60, 0x28, 0x28, 0x00, 0x00, 0x01, 0x00,
      0x14, 0x00, 0x00, 0x00, 0x01, 0x00, 0x12, 0x12, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_WW = {
      0x40, 0x08, 0x00, 0x00, 0x00, 0x02, 0x90, 0x28, 0x28, 0x00, 0x00, 0x01, 0x40, 0x14,
      0x00, 0x00, 0x00, 0x01, 0xA0, 0x12, 0x12, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_BW = {
      0x40, 0x08, 0x00, 0x00, 0x00, 0x02, 0x90, 0x28, 0x28, 0x00, 0x00, 0x01, 0x40, 0x14,
      0x00, 0x00, 0x00, 0x01, 0xA0, 0x12, 0x12, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_BB = {
      0x80, 0x08, 0x00, 0x00, 0x00, 0x02, 0x90, 0x28, 0x28, 0x00, 0x00, 0x01, 0x80, 0x14,
      0x00, 0x00, 0x00, 0x01, 0x50, 0x12, 0x12, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_WB = {
      0x80, 0x08, 0x00, 0x00, 0x00, 0x02, 0x90, 0x28, 0x28, 0x00, 0x00, 0x01, 0x80, 0x14,
      0x00, 0x00, 0x00, 0x01, 0x50, 0x12, 0x12, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  // LUT tables for 4-level grayscale mode
  static constexpr std::array<std::uint8_t, 44> LUT_VCOM_GRAY = {
      0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x60, 0x14, 0x14, 0x00, 0x00, 0x01, 0x00,
      0x14, 0x00, 0x00, 0x00, 0x01, 0x00, 0x13, 0x0A, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_WW_GRAY = {
      0x40, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x90, 0x14, 0x14, 0x00, 0x00, 0x01, 0x10, 0x14,
      0x0A, 0x00, 0x00, 0x01, 0xA0, 0x13, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_BW_GRAY = {
      0x40, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x90, 0x14, 0x14, 0x00, 0x00, 0x01, 0x00, 0x14,
      0x0A, 0x00, 0x00, 0x01, 0x99, 0x0C, 0x01, 0x03, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_WB_GRAY = {
      0x40, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x90, 0x14, 0x14, 0x00, 0x00, 0x01, 0x00, 0x14,
      0x0A, 0x00, 0x00, 0x01, 0x99, 0x0B, 0x04, 0x04, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

  static constexpr std::array<std::uint8_t, 42> LUT_BB_GRAY = {
      0x80, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x90, 0x14, 0x14, 0x00, 0x00, 0x01, 0x20, 0x14,
      0x0A, 0x00, 0x00, 0x01, 0x50, 0x13, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
};

} // namespace epaper
